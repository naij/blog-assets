KISSY.add("app/views/manage/picture/add",function(a,e,i,t,n,l,d){var r=l.all;return e.extend({tmpl:'<h2 class=h2-ex>\u56fe\u7247\u4e0a\u4f20</h2> <div class=pic-upload-cnt> <ul class=clearfix bx-tmpl="pics" bx-datakey="pics"> {{#pics}} <li> <div class=pic-cnt> <img src="{{filePath}}"  /> </div> <div class=meta> <div class="progress progress{{__index__}}"></div> {{fileSize}} </div> </li> {{/pics}} </ul> <div class=pic-upload-input> <input type=file name=upload id=J_upload multiple=multiple mx-change=fileChange  /> </div> </div> <p> <a href="javascript:;" class="btn btn-small mr10" mx-click=upload>\u4e0a\u4f20</a> <a href="javascript:;" mx-click=cancel>\u53d6\u6d88</a> </p>',init:function(a){this.manage("data",a)},locationChange:function(){this.render()},render:function(){var a=this;a.setViewPagelet({pics:[]},function(){a.components()})},components:function(){},picPreview:function(a){for(var e=this,i=e.getManaged("pagelet"),t=a.length,n=[],l=0;t>l;l++){var d=a[l],r={};if(d){r.fileSize=d.size>1048576?(Math.round(100*d.size/1048576)/100).toString()+"MB":(Math.round(100*d.size/1024)/100).toString()+"KB"}if(0==d.type.indexOf("image")){var c=new FileReader;c.readAsDataURL?c.readAsDataURL(d):c.readAsDataurl&&c.readAsDataurl(d),function(a,e){c.onload=function(l){a.filePath=l.target.result,n.push(a),e==t-1&&i.setChunkData("pics",n)}}(r,l)}}},uploadFile:function(a){function e(){if(s<a.length&&s!=a.length){var e=new FormData;e.append("author","Shiv Kumar"),e.append("name","Html 5 File API/FormData"),e.append("pic",a[s]);var d=new XMLHttpRequest;d.upload.addEventListener("progress",i,!1),d.addEventListener("load",t,!1),d.addEventListener("error",n,!1),d.addEventListener("abort",l,!1),d.open("POST","/api/pic/create"),d.send(e)}}function i(a){if(a.lengthComputable){var e=Math.round(100*a.loaded/a.total),i=r(".progress"+s);i.html('<div style="width:'+e.toString()+'%;"></div>')}}function t(){s++,e(),s==a.length&&(d.hideDialog(),c.getManaged("data").callback())}function n(){}function l(){}var c=this,s=(c.getManaged("pagelet"),0);e()},"fileChange<change>":function(a){a.halt();var e=this,i=r("#J_upload")[0].files;e.picPreview(i)},"upload<click>":function(a){a.halt();var e=this,i=r("#J_upload")[0].files;e.uploadFile(i)},"cancel<click>":function(){d.hideDialog()}})},{requires:["mxext/view","app/models/modelmanager","magix/vom","magix/router","node","app/util/util"]});